# SOFIA — Embedding Pipeline

**Build hash:** \`${GIT_HASH}\`

This repo was fully generated by \`bootstrap_sofia.sh\`. It contains:
- Data prep + negatives (\`prepare_data.py\`, \`mine_hard_negatives.py\`)
- KD distillation (\`distill_kd.py\`)
- Training with LoRA + multi-loss (\`train_sofia.py\`)
- Evaluation vs baseline (\`eval_compare.py\`)
- Serving API (\`serve_api.py\`)
- Config: \`config.yaml\`

## Quickstart
```bash
python -m venv .venv && source .venv/bin/activate
pip install -r requirements.txt

# Pipeline
python prepare_data.py
python mine_hard_negatives.py
python distill_kd.py --teachers BAAI/bge-m3 intfloat/e5-mistral-7b-instruct
python train_sofia.py --fp16
python eval_compare.py

# API
uvicorn serve_api.py:app --host 0.0.0.0 --port 8000
```

## Live Docs
- OpenAPI: http://localhost:8000/docs
- ReDoc:    http://localhost:8000/redoc
- Developer docs (auto-generated from source): open \`docs/site/index.html\` after running:
  \`pdoc --html --output-dir docs/site .\`

## Model Artifacts
- Main: \`./SOFIA\`
- Projections: \`./SOFIA/proj-1024\`, \`./SOFIA/proj-3072\`, \`./SOFIA/proj-4096\`

## Files → Responsibilities
- \`prepare_data.py\`: builds pairs, adds BM25 negatives
- \`mine_hard_negatives.py\`: mines FAISS hard negatives (encoder-based)
- \`distill_kd.py\`: soft labels from teacher ensemble
- \`train_sofia.py\`: LoRA + cosine + triplet
- \`eval_compare.py\`: MTEB subset for SOFIA vs Qwen baseline
- \`serve_api.py\`: /embed endpoint to consume embeddings
